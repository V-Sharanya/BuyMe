<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auctions - BUYME</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Special+Gothic+Expanded+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background: #333;
        }

        /* Fonts and Reset */
        body {
            margin: 0;
            font-family: "Roboto Mono", monospace;
            scroll-behavior: smooth;
        }

        /* Title Bar */
        .title-bar {
            position: sticky;
            top: 0;
            background-color: black;
            color: yellow;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 2rem;
            z-index: 10;
        }

        .title-bar .logo h1 {
            font-family: 'Special Gothic Expanded One', sans-serif;
            margin: 0;
        }

        .nav-links ul {
            font-weight: 100;
            list-style: none;
            display: flex;
            gap: 1.5rem;
            margin: 0;
            padding: 0;
            /* letter-spacing: 1px; */
        }

        .nav-links li {
            letter-spacing: 2px;
            position: relative;
        }

        /* .nav-links a {
  color: white;
  text-decoration: none;
  font-weight: bold;
} */


        .nav-links a {
            position: relative;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            font-family: "Roboto Mono", monospace;
            padding: 5px 0;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .nav-links a:hover {
            transform: translateY(-1px) scale(1.03);
        }

        .nav-links a:active {
            color: yellow;
            /* Red on click */
            transform: translateY(0);
            /* Reset pop */
        }



        html {
            scroll-behavior: smooth;
        }


        /* Dropdown */
        .dropdown {
            position: relative;
        }

        .shop-btn {
            cursor: pointer;
        }


        /* .dropdown-menu {
  display: none ; Ensure it's hidden on page load */
        /* position: absolute;
  top: 100%;
  left: 0;
  background-color: #333;
  list-style: none;
  padding: 0;
  margin: 0;
  min-width: 120px;
  z-index: 1000;
  border-radius: 4px;
}
 */
        ul .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 18px);
            /* pushes it a bit lower */
            left: 0;
            background-color: #333;
            list-style: none;
            padding: 0;
            margin: 0;
            min-width: 120px;
            z-index: 1000;
            border-radius: 4px;
        }


        /* Show the dropdown menu when hovering over the parent dropdown */
        .dropdown:hover .dropdown-menu {
            display: block;
        }


        .dropdown-menu li a {
            display: block;
            padding: 10px 20px;
            color: white;
            text-decoration: none;
        }

        .dropdown-menu li a {
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            display: block;
        }

        .dropdown-menu li a:hover {
            background-color: yellow;
            color: black;
        }

        /* Show the dropdown when hovering on the Shop button */
        .nav-links .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-menu {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border-top: 2px solid yellow;
            border-bottom: 2px solid yellow;
        }




        /* .dropdown-menu li a:hover {
  background-color: #555;
}
 */


        /* Main Banner */
        /* .main-banner {
  background: url('shoe1.jpg') no-repeat center center/cover;
  height: 100vh;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 0 2rem;
  letter-spacing: 1px;
  /* font-size: small; */
        /* } */

        .main-banner {
            background: url('images/wshoe5.jpg') no-repeat center center fixed;
            background-size: cover;
            height: 100vh;
            color: yellow;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 2rem;
        }

        .main-banner h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            /* color: black; */
        }

        .main-banner p {
            font-size: 1.0rem;
            max-width: 600px;
            /* color: black; */

        }



        .cta-btn {
            position: relative;
            margin-top: 2rem;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            background-color: black;
            color: yellow;
            cursor: pointer;
            border: none;
            overflow: hidden;
            z-index: 1;
            border-radius: 8px;
            transition: color 0.3s ease;
        }

        .cta-btn::before {
            content: "";
            position: absolute;
            background-color: yellow;
            width: 0%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            transition: width 0.4s ease;
        }

        .cta-btn:hover::before {
            width: 100%;
        }

        .cta-btn:hover {
            color: black;
        }


        /* User Menu and Settings Dropdown */
        .user-menu {
            position: relative;
        }

        .settings-icon {
            margin-left: 6px;
            font-size: 1.1em;
            vertical-align: middle;
        }

        ul .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #333;
            border-top: 2px solid yellow;
            border-bottom: 2px solid yellow;
            min-width: 180px;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            padding: 0;
            list-style: none;
            margin-top: 10px;
        }

        .user-menu.open .user-dropdown {
            display: block;
        }

        .user-dropdown li a {
            padding: 10px 16px;
            color: white;
            text-decoration: none;
            font-family: 'Roboto Mono', monospace;
            display: block;
            transition: all 0.3s ease;
        }

        .user-dropdown li a:hover {
            background-color: yellow;
            color: black;
        }

        /* Ensure proper spacing for the user menu */
        #user-menu {
            margin-left: 0rem;
        }

        #user-name-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* padding-top: 15px; */
        }


        /* Search bar */

        .input {
            border: 2px solid transparent;
            width: 50em;
            height: 1px;
            padding-left: 0.4em;
            outline: none;
            overflow: hidden;
            background-color: black;
            border-radius: 10px;
            transition: all 0.5s;
            margin-top: 20px;
            margin-left: 300px;
            color: #f3f3f3;
        }

        .input:hover,
        .input:focus {
            border: 2px solid yellow;
            box-shadow: 0px 0px 0px 7px rgba(236, 239, 94, 0.2);
            background-color: black;
        }









        .auction-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .auction-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .stop-auction-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .stop-auction-btn:hover {
            background-color: #b91c1c;
        }

        .auction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            /* height: 200px; */
            gap: 2rem;
            padding: 2rem 0;
        }

        .auction-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .auction-item:hover {
            transform: translateY(-5px);
        }

        .auction-item img {
            width: 100%;
            height: 250px;
            /* width: 200px; */
            object-fit: cover;
        }

        .auction-item-content {
            padding: 1.0rem;
        }

        .auction-item h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-family: 'Roboto Mono', monospace;
            margin-bottom: 0.1rem;
            font-size: 1rem;
        }

        .auction-item p {
            margin: 0.5rem 0;
            color: #666;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            margin: 0.1rem 0;
        }

        .place-bid-btn {
            background-color: black;
            color: yellow;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
            font-family: 'Roboto Mono', monospace;
        }

        .place-bid-btn:hover {
            background-color: yellow;
            color: black;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .place-bid-btn:active {
            transform: translateY(0);
        }

        .modal {
            display: none;
            position: fixed;
            top: -100px;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #222;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-family: 'Roboto Mono', monospace;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Roboto Mono', monospace;
        }

        .no-auctions {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-family: 'Roboto Mono', monospace;
        }

        .error-message {
            text-align: center;
            padding: 2rem;
            color: #ffcc00;
            font-family: 'Roboto Mono', monospace;
        }

        .auction-timer {
            color: #ffcc00;
            font-weight: bold;
        }

        .auction-ended {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }

        .auction-ended p {
            color: #ff6200;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .winner-info {
            background-color: #fff;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .winner-info p {
            color: #ffcc00;
            margin: 5px 0;
        }

        .winner-name {
            font-weight: bold;
            color: #ff9900;
        }

        .winning-bid {
            font-weight: bold;
            color: #ffcc00;
        }

        .section-title {
            text-align: left;
            margin: 2rem 0;
            font-weight: bolder;
            font-family: 'Roboto mono', monospace;
            color: white;
        }

        .user-menu {
            position: relative;
        }

        .settings-icon {
            margin-left: 6px;
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* .user-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: #333;
    border-top: 2px solid yellow;
    border-bottom: 2px solid yellow;
    min-width: 180px;
    z-index: 100;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    border-radius: 4px;
    padding: 0;
    list-style: none;
    margin-top: 10px;
  }  */

        .user-menu.open .user-dropdown {
            display: block;
        }

        .user-dropdown li a {
            padding: 10px 16px;
            color: white;
            text-decoration: none;
            font-family: 'Roboto Mono', monospace;
            display: block;
            transition: all 0.3s ease;
        }

        .user-dropdown li a:hover {
            background-color: yellow;
            color: black;
        }

        /* Ensure proper spacing for the user menu */
        /* #user-menu {
    margin-left: 1.5rem;
  }
  
  #user-name-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  } */
    </style>
</head>

<body>
    <!-- Title Bar Section -->
    <header class="title-bar">
        <div class="logo">
            <h1>BUYME</h1>
        </div>
        <nav class="nav-links">
            <ul>
                <li><a href="#">Home</a></li>
                <!-- <li><a href="#">Shop</a></li> -->
                <li class="dropdown">
                    <a href="auction.html" class="shop-btn">Shop</a>
                    <ul class="dropdown-menu">
                        <!-- <li><a href="men.html">Men</a></li> -->
                        <!-- <li><a href="women.html">Women</a></li> -->
                        <!-- <li><a href="unisex.html">Unisex</a></li> -->
                    </ul>
                </li>
                <li><a href="about.html">About us</a></li>
                <li><a href="#contact-us">Contact</a></li>
                <li id="login-link"><a href="login.html">Login</a></li>
                <!-- <li id="user-name" style="display: none;"><a></a></li> 
            <li id="user-menu" class="user-menu" style="display: none;">
              <a href="#" id="user-name-link">
                <span class="settings-icon">&#9881;</span>Profile
              </a>
              <ul class="user-dropdown" >
                <li><a href="#" id="my-bid-history">My Bid History</a></li>
                <li><a href="#" id="reset-password">Reset Password</a></li>
                <li><a href="#" id="delete-account">Delete Account</a></li>
                <li><a href="#" id="logout">Logout</a></li>
              </ul>
            </li> -->

                <li id="user-menu" class="user-menu" style="display: none;">
                    <a href="#" id="user-name-link"></a>
                    <ul class="user-dropdown">
                        <li><a href="#" id="my-bid-history">My Bid History</a></li>
                        <li><a href="#" id="reset-password">Reset Password</a></li>
                        <li><a href="#" id="delete-account">Delete Account</a></li>
                        <li><a href="#" id="logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <!-- <input placeholder="Enter something here..." class="input" /> -->
    <input type="text" id="searchInput" class="input" placeholder="Search for products...">


    <main class="auction-container">
        <!-- Active Auctions Section -->
        <h2 class="section-title">Live Auctions</h2>
        <div class="auction-grid" id="activeAuctions">
            <!-- Active auction items will be dynamically inserted here -->
        </div>

        <!-- Completed Auctions Section -->
        <h2 class="section-title">Completed Auctions</h2>
        <div class="auction-grid" id="completedAuctions">
            <!-- Completed auction items will be dynamically inserted here -->
        </div>
    </main>





    <script>
        const API_BASE_URL = 'http://localhost:5000';

        document.addEventListener('DOMContentLoaded', () => {
            // Get the elements
            const dropdown = document.querySelector('.dropdown');
            const dropdownMenu = dropdown.querySelector('.dropdown-menu');
            const userMenu = document.getElementById('user-menu');
            const userNameElement = document.getElementById('user-name');
            const loginLink = document.getElementById('login-link');
            let timer;

            // Hide dropdown menu initially
            dropdownMenu.style.display = 'none';

            // Dropdown hover behavior
            dropdown.addEventListener('mouseenter', () => {
                clearTimeout(timer);
                dropdownMenu.style.display = 'block';
            });

            dropdown.addEventListener('mouseleave', () => {
                timer = setTimeout(() => {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });

            dropdownMenu.addEventListener('mouseenter', () => {
                clearTimeout(timer);
            });

            dropdownMenu.addEventListener('mouseleave', () => {
                timer = setTimeout(() => {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });

            // Handle user login state
            const user = sessionStorage.getItem('user');
            if (user) {
                const parsedUser = JSON.parse(user);
                // userNameElement.textContent = parsedUser.username;
                document.getElementById('user-name-link').textContent = parsedUser.username;
                userMenu.style.display = 'block';
                loginLink.style.display = 'none';
            } else {
                userMenu.style.display = 'none';
                loginLink.style.display = 'block';
            }

            // Toggle user dropdown
            document.getElementById('user-name-link').addEventListener('click', (e) => {
                e.preventDefault();
                userMenu.classList.toggle('open');
            });

            // Close dropdown if clicked outside
            window.addEventListener('click', (e) => {
                if (!userMenu.contains(e.target) && e.target.id !== 'user-name-link') {
                    userMenu.classList.remove('open');
                }
            });

            // My Bid History
            document.getElementById('my-bid-history').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'my_bids.html';
            });

            // Reset Password
            document.getElementById('reset-password').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'reset_pass.html';
            });

            // Delete Account
            document.getElementById('delete-account').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                    const user = JSON.parse(sessionStorage.getItem('user'));
                    try {
                        const response = await fetch(`http://localhost:5000/api/users/${user.user_id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            alert('Account deleted.');
                            sessionStorage.clear();
                            window.location.href = 'index.html';
                        } else {
                            alert('Failed to delete account.');
                        }
                    } catch (error) {
                        console.error('Error deleting account:', error);
                        alert('Something went wrong.');
                    }
                }
            });

            // Logout
            document.getElementById('logout').addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                window.location.href = 'login.html';
            });
            window.onload = function () {
                const userNameElement = document.getElementById('user-name');
                const loginLink = document.getElementById('login-link');

                const user = sessionStorage.getItem('user');

                if (user) {
                    const parsedUser = JSON.parse(user);
                    //   userNameElement.textContent = parsedUser.username;
                    document.getElementById('user-name-link').textContent = parsedUser.username;
                    userNameElement.style.display = 'block';
                    loginLink.style.display = 'none';
                } else {
                    userNameElement.style.display = 'none';
                    loginLink.style.display = 'block';
                }
            };
        });


        async function fetchAuctions() {
            try {
                const response = await fetch(`${API_BASE_URL}/pi/auctions/all`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received auction data:', data); // Debug log
                if (data.success && data.auctions) {
                    displayAuctions(data.auctions);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error fetching auctions:', error);
                document.getElementById('activeAuctions').innerHTML = `
                    <div class="error-message">
                        <p>Unable to connect to the server. Please make sure the backend server is running.</p>
                        <p>Error details: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayAuctions(auctions) {
            const activeAuctionsContainer = document.getElementById('activeAuctions');
            const completedAuctionsContainer = document.getElementById('completedAuctions');

            activeAuctionsContainer.innerHTML = '';
            completedAuctionsContainer.innerHTML = '';

            const now = new Date();

            auctions.forEach(auction => {
                const auctionEndTime = new Date(auction.end_time);
                const isOngoing = auctionEndTime > now;
                const auctionId = auction.auction_id;
                if (!auctionId) return;

                const auctionItem = document.createElement('div');
                auctionItem.className = 'auction-item';

                // Check if user is admin
                const user = JSON.parse(sessionStorage.getItem('user') || '{}');
                const isAdmin = user.role === 'admin';

                auctionItem.innerHTML = `
                    <img src="${API_BASE_URL}${auction.image_url}" alt="${auction.item_name}">
                    <div class="auction-item-content">
                        <h3>${auction.item_name}</h3>
                        <p>Current Bid: $${auction.current_bid || auction.starting_price}</p>
                        <p>Ends: ${auctionEndTime.toLocaleString()}</p>
                        <div class="auction-ended-placeholder"></div>
                        ${isOngoing ?
                        `<div class="auction-actions">
                                <button class="place-bid-btn" onclick="window.location.href='product_detail.html?auction_id=${auctionId}'">Place Bid</button>
                                ${isAdmin ? `<button class="stop-auction-btn" onclick="stopAuction(${auctionId})">Stop Auction</button>` : ''}
                            </div>` :
                        ''
                    }
                    </div>
                `;

                if (isOngoing) {
                    activeAuctionsContainer.appendChild(auctionItem);
                } else {
                    completedAuctionsContainer.appendChild(auctionItem);
                    // Fetch bids and update winner info for completed auctions
                    fetch(`${API_BASE_URL}/api/bids/auction/${auctionId}`)
                        .then(res => res.json())
                        .then(bids => {
                            const placeholder = auctionItem.querySelector('.auction-ended-placeholder');
                            if (!bids || bids.length === 0) {
                                placeholder.innerHTML = `<div class="auction-ended"><p>Auction Ended</p><div class="winner-info"><p>No bids placed</p></div></div>`;
                                return;
                            }
                            // Sort bids by amount desc, then by earliest time
                            bids.sort((a, b) => {
                                const amountA = parseFloat(a.bid_amount) || 0;
                                const amountB = parseFloat(b.bid_amount) || 0;
                                if (amountB === amountA) {
                                    return new Date(a.bid_time) - new Date(b.bid_time);
                                }
                                return amountB - amountA;
                            });
                            const highestBid = bids[0];
                            const highestBidAmount = parseFloat(highestBid.bid_amount) || 0;
                            const startingPrice = parseFloat(auction.starting_price) || 0;
                            if (highestBidAmount >= startingPrice) {
                                placeholder.innerHTML = `
                                    <div class="auction-ended">
                                        <p>Auction Ended</p>
                                        <div class="winner-info">
                                            <p>Winner: <span class="winner-name">${highestBid.username || 'Anonymous'}</span></p>
                                            <p>Winning Bid: <span class="winning-bid">$${highestBidAmount.toFixed(2)}</span></p>
                                            <p>Bid Time: <span class="bid-time">${new Date(highestBid.bid_time).toLocaleString()}</span></p>
                                        </div>
                                    </div>
                                `;
                            } else {
                                placeholder.innerHTML = `
                                    <div class="auction-ended">
                                        <p>Auction Ended</p>
                                        <div class="winner-info">
                                            <p>Bid did not exceed minimum price</p>
                                        </div>
                                    </div>
                                `;
                            }
                        })
                        .catch(() => {
                            const placeholder = auctionItem.querySelector('.auction-ended-placeholder');
                            placeholder.innerHTML = `<div class="auction-ended"><p>Auction Ended</p><div class="winner-info"><p>Could not load winner info</p></div></div>`;
                        });
                }
            });
        }

        // Fetch auctions when page loads
        document.addEventListener('DOMContentLoaded', fetchAuctions);

        // Set up auto-refresh for auctions
        setInterval(fetchAuctions, 30000); // Refresh every 30 seconds

        // Check user login status
        window.onload = function () {
            const userNameElement = document.getElementById('user-name');
            const loginLink = document.getElementById('login-link');

            const user = sessionStorage.getItem('user');

            if (user) {
                const parsedUser = JSON.parse(user);
                userNameElement.textContent = parsedUser.username;
                userNameElement.style.display = 'block';
                loginLink.style.display = 'none';
            } else {
                userNameElement.style.display = 'none';
                loginLink.style.display = 'block';
            }
        };

        function createAuctionCard(auction) {
            const card = document.createElement('div');
            card.className = 'auction-card';

            const endTime = new Date(auction.end_time);
            const isOngoing = endTime > new Date();

            card.innerHTML = `
                <div class="auction-image">
                    <img src="${API_BASE_URL}${auction.image_url}" alt="${auction.item_name}">
                </div>
                <div class="auction-details">
                    <h3>${auction.item_name}</h3>
                    <div class="auction-info">
                        <p class="current-bid">Current Bid: $${auction.current_bid || auction.starting_price}</p>
                        <p class="end-time">Ends: ${endTime.toLocaleString()}</p>
                    </div>
                    <div class="bid-history">
                        <h4>Bid History</h4>
                        <ul class="bid-list" id="bidList-${auction.auction_id}">
                            <!-- Bids will be dynamically added here -->
                        </ul>
                    </div>
                    
                    ${!isOngoing ? `
                        <div class="auction-ended">
                            <p>Auction Ended</p>
                            ${auction.winner ? `
                                <div class="winner-info">
                                    <p>Winner: <span class="winner-name">${auction.winner.username}</span></p>
                                    <p>Winning Bid: <span class="winning-bid">$${auction.current_bid}</span></p>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            // Fetch and display bids for this auction
            fetchBidsForAuction(auction.auction_id);

            return card;
        }

        // Add stop auction function
        async function stopAuction(auctionId) {
            if (!confirm('Are you sure you want to stop this auction?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/pi/auctions/${auctionId}/stop`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Auction stopped successfully');
                    fetchAuctions(); // Refresh the auctions list
                } else {
                    alert(data.message || 'Failed to stop auction');
                }
            } catch (error) {
                console.error('Error stopping auction:', error);
                alert('An error occurred while stopping the auction');
            }
        }


        // Search bar logic

        // const searchInput = document.getElementById('searchInput');
        // const auctionCards = document.querySelectorAll('.auction-card');

        // searchInput.addEventListener('input', () => {
        //     const query = searchInput.value.toLowerCase();

        //     auctionCards.forEach(card => {
        //         const title = card.querySelector('h2')?.textContent.toLowerCase() || '';
        //         const description = card.querySelector('p')?.textContent.toLowerCase() || '';
        //         const username = card.querySelector('.auction-username')?.textContent.toLowerCase() || '';
        //         const tags = card.querySelector('.auction-tags')?.textContent.toLowerCase() || '';

        //         const matches =
        //             title.includes(query) ||
        //             description.includes(query) ||
        //             username.includes(query) ||
        //             tags.includes(query);

        //         card.style.display = matches ? 'block' : 'none';
        //     });
        // });

    </script>

<script>
    // Add this to your existing JavaScript code

document.addEventListener("DOMContentLoaded", () => {
const searchInput = document.getElementById("searchInput");
let allAuctions = []; // Will store all auctions for filtering

// Create price filter elements
const filterContainer = document.createElement("div");
filterContainer.className = "filter-container";
filterContainer.innerHTML = `
<div>
  <button id="resetFilters" class="reset-btn">Reset</button>
</div>
`;

// Insert after the search input
const searchInputParent = searchInput.parentNode;
searchInputParent.insertBefore(filterContainer, searchInput.nextSibling);

// Add CSS for the new elements
const style = document.createElement("style");
style.textContent = `
.filter-container {
  display: flex;
  justify-content: center;
  margin-top: 10px;
  margin-bottom: 20px;
}

.reset-btn {
  background-color: black;
  color: yellow;
  border: 1px solid yellow;
  border-radius: 5px;
  padding: 5px 15px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.reset-btn:hover {
  background-color: yellow;
  color: black;
}

.no-results {
  text-align: center;
  color: white;
  padding: 20px;
  font-family: 'Roboto Mono', monospace;
}
`;
document.head.appendChild(style);

//   // Get references to the filter elements
//   const minBidFilter = document.getElementById("minBidFilter");
//   const maxBidFilter = document.getElementById("maxBidFilter");
const resetFiltersBtn = document.getElementById("resetFilters");

// Override the existing fetchAuctions function
window.fetchAuctions = async function() {
try {
  const response = await fetch(`${API_BASE_URL}/pi/auctions/all`);
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  const data = await response.json();
  console.log('Received auction data:', data);
  
  if (data.success && data.auctions) {
    // Store all auctions for filtering
    allAuctions = data.auctions;
    applyFilters(); // Apply any existing filters
  } else {
    throw new Error('Invalid response format');
  }
} catch (error) {
  console.error('Error fetching auctions:', error);
  document.getElementById('activeAuctions').innerHTML = `
    <div class="error-message">
      <p>Unable to connect to the server. Please make sure the backend server is running.</p>
      <p>Error details: ${error.message}</p>
    </div>
  `;
}
};

// Function to apply all filters and display results
function applyFilters() {
const searchTerm = searchInput.value.toLowerCase();

// Filter auctions by all criteria
const filteredAuctions = allAuctions.filter(auction => {
  const itemName = auction.item_name.toLowerCase();
 // const currentBid = parseFloat(auction.current_bid || auction.starting_price);
  
  // Check name filter
  const nameMatch = itemName.includes(searchTerm);
  
  // Check bid range
//   const bidInRange = currentBid >= minBid && (maxBidFilter.value === "" || currentBid <= maxBid);
  
  return nameMatch;
});

displayFilteredAuctions(filteredAuctions);
}

// Function to display filtered auctions
function displayFilteredAuctions(auctions) {
const activeAuctionsContainer = document.getElementById('activeAuctions');
const completedAuctionsContainer = document.getElementById('completedAuctions');

activeAuctionsContainer.innerHTML = '';
completedAuctionsContainer.innerHTML = '';

const now = new Date();
let activeCount = 0;
let completedCount = 0;

// Show message if no auctions match filters
if (auctions.length === 0) {
  activeAuctionsContainer.innerHTML = `
    <div class="no-results">
      <p>No auctions match your search criteria.</p>
    </div>
  `;
  completedAuctionsContainer.innerHTML = '';
  return;
}

auctions.forEach(auction => {
  const auctionEndTime = new Date(auction.end_time);
  const isOngoing = auctionEndTime > now;
  const auctionId = auction.auction_id;
  if (!auctionId) return;
  
  const auctionItem = document.createElement('div');
  auctionItem.className = 'auction-item';
  
  // Check if user is admin
  const user = JSON.parse(sessionStorage.getItem('user') || '{}');
  const isAdmin = user.role === 'admin';
  
  auctionItem.innerHTML = `
    <img src="${API_BASE_URL}${auction.image_url}" alt="${auction.item_name}">
    <div class="auction-item-content">
      <h3>${auction.item_name}</h3>
      <p>Current Bid: $${auction.current_bid || auction.starting_price}</p>
      <p>Ends: ${auctionEndTime.toLocaleString()}</p>
      <div class="auction-ended-placeholder"></div>
      ${isOngoing ? 
        `<div class="auction-actions">
          <button class="place-bid-btn" onclick="window.location.href='product_detail.html?auction_id=${auctionId}'">Place Bid</button>
          ${isAdmin ?` <button class="stop-auction-btn" onclick="stopAuction(${auctionId})">Stop Auction</button>`: ''}
        </div>` : 
        ''
      }
    </div>
  `;
  
  if (isOngoing) {
    activeAuctionsContainer.appendChild(auctionItem);
    activeCount++;
  } else {
    completedAuctionsContainer.appendChild(auctionItem);
    completedCount++;
    
    // Fetch bids and update winner info for completed auctions
    fetch(`${API_BASE_URL}/api/bids/auction/${auctionId}`)
      .then(res => res.json())
      .then(bids => {
        const placeholder = auctionItem.querySelector('.auction-ended-placeholder');
        if (!bids || bids.length === 0) {
          placeholder.innerHTML = `<div class="auction-ended"><p>Auction Ended</p><div class="winner-info"><p>No bids placed</p></div></div>`;
          return;
        }
        
        // Sort bids by amount desc, then by earliest time
        bids.sort((a, b) => {
          const amountA = parseFloat(a.bid_amount) || 0;
          const amountB = parseFloat(b.bid_amount) || 0;
          if (amountB === amountA) {
            return new Date(a.bid_time) - new Date(b.bid_time);
          }
          return amountB - amountA;
        });
        
        const highestBid = bids[0];
        const highestBidAmount = parseFloat(highestBid.bid_amount) || 0;
        const minPrice = parseFloat(auction.min_price) || parseFloat(auction.starting_price) || 0;
        
        // Only show winner if highest bid exceeds minimum price
        if (highestBidAmount >= minPrice) {
          placeholder.innerHTML = `
            <div class="auction-ended">
              <p>Auction Ended</p>
              <div class="winner-info">
                <p>Winner: <span class="winner-name">${highestBid.username || 'Anonymous'}</span></p>
                <p>Winning Bid: <span class="winning-bid">$${highestBidAmount.toFixed(2)}</span></p>
                <p>Bid Time: <span class="bid-time">${new Date(highestBid.bid_time).toLocaleString()}</span></p>
              </div>
            </div>
          `;
        } else {
          placeholder.innerHTML = `
            <div class="auction-ended">
              <p>Auction Ended</p>
              <div class="winner-info">
                <p>No winner - highest bid did not meet minimum price</p>
              </div>
            </div>
          `;
        }
      })
      .catch(() => {
        const placeholder = auctionItem.querySelector('.auction-ended-placeholder');
        placeholder.innerHTML = `<div class="auction-ended"><p>Auction Ended</p><div class="winner-info"><p>Could not load winner info</p></div></div>`;
      });
  }
});

// Show messages if no auctions in a category after filtering
if (activeCount === 0) {
  activeAuctionsContainer.innerHTML = `
    <div class="no-results">
      <p>No active auctions match your search criteria.</p>
    </div>
  `;
}

if (completedCount === 0 && auctions.length > 0) {
  completedAuctionsContainer.innerHTML = `
    <div class="no-results">
      <p>No completed auctions match your search criteria.</p>
    </div>
  `;
}
}

// Add event listeners for all filter inputs
searchInput.addEventListener('input', applyFilters);

// Reset filters button
resetFiltersBtn.addEventListener('click', () => {
searchInput.value = '';
applyFilters();
});

// Initial fetch of auctions
fetchAuctions();
});
</script>
</body>

</html>

